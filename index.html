<!doctype html>

<!-- METADATA -->
<meta charset="utf-8">
<title>JS and Ruby in the browser (template)</title>

<!-- LOAD DEPENDENCIES -->
<script src="opal_app.js" type="text/javascript"></script>

<script src="bower_components/codemirror/lib/codemirror.js"></script>
<script src="bower_components/codemirror/mode/ruby/ruby.js"></script>
<script src="bower_components/codemirror/mode/javascript/javascript.js"></script>
<link rel="stylesheet" type="text/css" href="bower_components/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="bower_components/codemirror/theme/base16-light.css">


<!-- TOSS SOME STYLES UP IN HERE! -->
<style>
body {
  margin:        3em;
  margin-bottom: 5em;
  font-size:     1.5em;
}

.challenge {
   border: 2px solid #555;
   display: -webkit-flex;
   display: flex;

	-webkit-align-items: center;
	align-items: center;

  -webkit-justify-content: center;
  justify-content: center;

  -webkit-flex-direction: row;
  flex-direction: row;

  -webkit-align-items: stretch;
  -ms-flex-align: stretch;
  align-items: stretch;
}

.challenge textarea {
  display: inherit;
  margin: 0;
}
.challenge .test-results {
  width:   35%;
  background-color: #f5f5f5;
  margin:           0;      /* override browser default */
  padding:          0.5em;  /* override browser default */
  list-style-type:  none;   /* override browser default */
}
.test-results .result {
  padding:     0.3em;
  color:       #f5f5f5;
  font-family: sans-serif;
}
.test-results .result + .result {
  margin-top: 3px; /*#f5f5f5;*/
}
.test-results .pass {
  background-color: #90a959;
}
.test-results .fail {
  background: #8f5536;
}
.cm-my-custom-style {
  border: 1px solid blue;
}
.CodeMirror span.cm-var-number-0 {
  color: #A00
}
.CodeMirror span.cm-var-number-1 {
  color: #0A0
}
.CodeMirror span.cm-var-number-2 {
  color: #00A
}
.CodeMirror span.cm-var-number-3 {
  color: #AA0
}
.CodeMirror span.cm-var-number-4 {
  color: #0AA
}
.cm-def {
  text-decoration: underline;
}
</style>

Some text before.

<div class="challenge">
<textarea>
(f =&gt; (x =&gt; f(x(x)))(x =&gt; f(x(x)))

// (car =&gt;( cdr =&gt;( cons =&gt;(
//  _or =&gt;( _and =&gt;( _if =&gt;( _true =&gt;( _false =&gt;(
//  progression =&gt;( noop =&gt;( print_num =&gt;( y_combinator =&gt;(
//  succ =&gt;( pred =&gt;( is_zero =&gt;(
//  n0 =&gt;( n1 =&gt;( n2 =&gt;( n3 =&gt;( n4 =&gt;( n5 =&gt;( n6 =&gt;( n7 =&gt;( n8 =&gt;( n9 =&gt;( n10 =&gt;
//
//   // -----  This code recursively counts down from 10  -----
//   y_combinator(
//     (recur =&gt; num =&gt;
//       progression
//         (print_num(num))
//         (_if (is_zero(num))
//              (noop)
//              (_ =&gt; recur(pred(num))))))
//     (n10) // &lt;-- See? We call it with 10!
//
// // ==========  All the support code we need in order to pull it off  ==========
//
// // -----  Church Numerals  -----
// )(succ(n9)
// ))(succ(n8)
// ))(succ(n7)
// ))(succ(n6)
// ))(succ(n5)
// ))(succ(n4)
// ))(succ(n3)
// ))(succ(n2)
// ))(succ(n1)
// ))(succ(n0)
// ))(fn =&gt; arg =&gt; arg
// ))(n =&gt; n(_ =&gt; _false)(_true)
//
// // this is the integer predecessor function,
// // I made it up, IDK how you're actually supposed to do it
// ))(n1 =&gt; fn =&gt; arg =&gt;
//     (state =&gt; delayedFn =&gt;
//         cdr(n1(delayedFn)(state)))
//       (cons(_false)(arg))// initial state
//       ((state =&gt;
//         (already_skipped =&gt; arg =&gt;
//             _if (already_skipped(state))
//                 (_=&gt; cons(_true)(fn(arg(state))))
//                 (_=&gt; cons(_true)(arg(state))))
//         (car)
//         (cdr)))
// ))(num =&gt; fn =&gt; arg =&gt; num(fn)(fn(arg))
//
// // -----  Miscellaneous  -----
// // The y combinator ^_^
// ))((y =&gt; fn =&gt; n =&gt; fn(y(y)(fn))(n))
//    (y =&gt; fn =&gt; n =&gt; fn(y(y)(fn))(n))
//
// // print_num, the one place we cheat
// ))(num =&gt; console.log(num(n =&gt; n+1)(0)) || num
// ))(_ =&gt; _
// ))(first =&gt; second =&gt; second
//
// // -----  true, false, boolean operators, if statements, etc  -----
// ))(true_branch =&gt; false_branch =&gt; false_branch
// ))(true_branch =&gt; false_branch =&gt; true_branch
// ))(bool =&gt; true_branch =&gt; false_branch =&gt;
//      bool(true_branch)(false_branch)(bool)
// ))(bool1 =&gt; bool2 =&gt; bool1(bool2)(bool1)
// ))(bool1 =&gt; bool2 =&gt; bool1(bool1)(bool2)
//
// // -----  linked lists  -----
// ))(first =&gt; second =&gt; fn =&gt; fn(first)(second)
// ))(cons_cell =&gt; cons_cell(first =&gt; second =&gt; second)
// ))(cons_cell =&gt; cons_cell(first =&gt; second =&gt; first)
// )
</textarea>
<ul class="test-results"></ul>
</div>

Some text between.


<script type="text/javascript">
"use strict"
// Heavily influenced by CodeMirror's html mixed mode

CodeMirror.defineMode("colouredVarTokens", function (config, parserConfig) {
  var jsMode = CodeMirror.getMode(config, {name: "javascript", jsMode: true})
  var i = 0

  function colouredVarTokens(stream, state) {
    let style     = jsMode.token(stream, state.jsState)
    let token     = stream.current()
    let scopes    = state.scopes
    let crntScope = scopes[scopes.length-1]
    let addClass  = ""
    if(style === undefined && token === "(") {
      scopes.push({})
      i++
    } else if(style === "operator" && token === "=>") {
      // scopes.push({})
      // i++
    } else if(style === undefined && token === ")") {
      scopes.pop()
      i--
    } else if(style === "def") {
      crntScope[token] = " var-number-"+i
      addClass += crntScope[token]
    } else if(style === "variable" || style === "variable-2") {
      for(var j = scopes.length; j--;)
        if(scopes[j][token]) {
          addClass += scopes[j][token]
          break
        }
    } else {
      // noop, something we don't care about
    }
    return style + addClass
  };

  return {
    startState: function () {
      return {
        scopes: [{}],
        token: colouredVarTokens,
        jsState: CodeMirror.startState(jsMode)
      }
    },

    copyState: function (state) {
      return {
        token:   state.token,
        scopes:  state.scopes,
        jsState: CodeMirror.copyState(jsMode, state.jsState),
      }
    },

    token: function (stream, state) {
      return state.token(stream, state)
    },

    indent: function (state, textAfter) {
      return jsMode.indent(state.jsState, textAfter);
    },
  };
}, "javascript");
</script>


<script type="text/javascript">
var challenges = document.querySelectorAll('.challenge')
challenges.forEach(function(challengeDom) {
  const cmDom = challengeDom.querySelector('textarea')

  // Options:
  // keyMap   - vim/emacs/sublime, but you have to explicitly load the keymap code
  // exraKeys - additional keybindings

  // Extensions:
  //   runmode     lets you run a mode against the code (this is for parsing / syntax checking?)
  //   colorize    lets you syntax highlight code snippets
  //   fullscreen
  //   panel       seems to only be above/below
  cmDom.cm = CodeMirror.fromTextArea(cmDom, {
    mode:        "colouredVarTokens",
    lineNumbers: true,
    theme:       'base16-light',
  })
  cmDom.cm.setSize({height: '100%'})
  cmDom.cm.on('changes', (cm, change) => testAnswer(cm))
  testAnswer(cmDom.cm)
  if(!window.cm) window.cm = cmDom.cm

  function testAnswer(cm) {
    return
    const ruby        = cm.getValue()
    const evaluatedTo = Opal.eval(ruby)
    const tests       = [
      {name: 'Test 1', inputs: [ 0], output:  10},
      {name: 'Test 2', inputs: [ 1], output:  11},
      {name: 'Test 3', inputs: [ 2], output:  14},
      {name: 'Test 4', inputs: [10], output: 110},
    ]

    const resultsDom     = challengeDom.querySelector('.test-results')
    while (resultsDom.firstChild)
      resultsDom.removeChild(resultsDom.firstChild)

    tests.forEach(test => {
      const actualOutput  = evaluatedTo(...test.inputs)
      const resultDom     = document.createElement('li')
      resultDom.innerText = `${test.name}: Expected ${test.output}, Actual ${actualOutput}`
      resultsDom.appendChild(resultDom)
      if(actualOutput === test.output)
        resultDom.classList.add('result', 'pass')
      else
        resultDom.classList.add('result', 'fail')
    })
  }
})
</script>

